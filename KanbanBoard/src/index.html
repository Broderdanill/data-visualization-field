<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Kanban Board</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f2f4f7; }
    .kanban-column {
      min-width: 250px;
      flex: 1;
      margin: 8px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .kanban-column h5 {
      background-color: #f8f9fa;
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      margin: 0;
    }
    .kanban-card {
      background: #e9ecef;
      border-radius: 5px;
      padding: 10px;
      margin: 8px;
      cursor: grab;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .kanban-card img {
      width: 100%;
      max-height: 120px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 6px;
    }
    .kanban-field {
      font-size: 13px;
    }
    @media (max-width: 768px) {
      #board { flex-direction: column; }
    }
  </style>
</head>
<body class="p-2">
  <div id="board" class="d-flex flex-wrap"></div>

  <script>
    let draggedCard = null;

    ARQualLoad = function(parameters) {
      const formName = parameters["formName"];
      const lanes = JSON.parse(parameters["lanes"] || "[]");
      const titleField = parameters["titleField"];
      const updateField = parameters["updateField"];
      const cardFields = (parameters["cardFields"] || "").split(",").map(f => f.trim()).filter(f => f);
      const thumbnailField = parameters["thumbnailField"];
      const colorField = parameters["colorField"];

      if (!formName || !lanes.length || !titleField || !updateField) {
        document.getElementById("board").innerHTML = "<div class='alert alert-danger'>Missing required parameters</div>";
        return;
      }

      const allFields = [...new Set([titleField, updateField, thumbnailField, colorField, ...cardFields].filter(f => f))];

      const board = document.getElementById("board");
      board.innerHTML = "";

      lanes.forEach(lane => {
        const column = document.createElement("div");
        column.className = "kanban-column";
        column.dataset.laneValue = lane.value;
        column.innerHTML = `<h5>${lane.label}</h5>`;
        column.addEventListener("dragover", e => e.preventDefault());
        column.addEventListener("drop", function() {
          if (draggedCard) {
            this.querySelector(".kanban-body").appendChild(draggedCard);
            const requestId = draggedCard.dataset.requestId;
            const updateData = {};
            updateData[updateField] = this.dataset.laneValue;
            ARUpdateEntry(formName, requestId, updateData,
              () => console.log("Updated:", requestId),
              err => alert("Error updating: " + err.message)
            );
          }
        });

        const body = document.createElement("div");
        body.className = "kanban-body p-2";
        column.appendChild(body);
        board.appendChild(column);

        ARGetListEntryWithFields(formName, lane.qual, 0, 100, allFields, entries => {
          entries.forEach(entry => {
            const card = document.createElement("div");
            card.className = "kanban-card";
            card.draggable = true;
            card.dataset.requestId = entry["Request ID"];

            const color = entry[colorField] || "";
            if (color) card.style.backgroundColor = color;

            if (thumbnailField && entry[thumbnailField]) {
              card.innerHTML += `<img src="${entry[thumbnailField]}" alt="thumb"/>`;
            }

            card.innerHTML += `<strong>${entry[titleField] || "(no title)"}</strong><br/>`;

            cardFields.forEach(f => {
              const val = entry[f] || "";
              card.innerHTML += `<div class="kanban-field"><b>${f}:</b> ${val}</div>`;
            });

            card.addEventListener("dragstart", () => draggedCard = card);
            card.addEventListener("dragend", () => draggedCard = null);

            body.appendChild(card);
          });
        }, err => console.error(err));
      });
    };
  </script>
</body>
</html>